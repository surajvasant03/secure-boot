name: CI Pipeline

on:
  push:
    branches:
      - main
      - master

jobs:
  lint-python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install flake8
        run: pip install flake8

      - name: Lint Python
        run: flake8 app || true

  helm-lint:
    runs-on: ubuntu-latest
    needs: lint-python
    steps:
      - uses: actions/checkout@v3

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Helm Lint
        run: helm lint helm/secure-boot

  terraform-validate:
    runs-on: ubuntu-latest
    needs: helm-lint
    steps:
      - uses: actions/checkout@v3

      - name: Install Terraform
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gnupg software-properties-common curl
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update -y
          sudo apt-get install terraform -y

      - name: Terraform Validate
        run: |
          cd terraform
          terraform init
          terraform validate

  docker-build:
    runs-on: ubuntu-latest
    needs: terraform-validate
    steps:
      - uses: actions/checkout@v3

      - name: Docker Build
        run: docker build -t secure-boot .

